C51 COMPILER V9.00   TM1629                                                                09/04/2015 10:18:59 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE TM1629
OBJECT MODULE PLACED IN tm1629.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE Receiver\tm1629.c LARGE BROWSE INCDIR(.\Receiver) DEBUG OBJECTEXTEND PRINT(
                    -.\tm1629.lst) TABS(2) OBJECT(tm1629.obj)

line level    source

   1          #include "tm1629.h"
   2          #include "timer.h"
   3          #include "usart.h"
   4          
   5          unsigned char const CODE[] = { 0x3F, 0x06, 0x5B, 0x4F, 0x66, 0x6D, 0x7D, 0x07, 0x7F, 0x6F, 0x77, 0x7C, 0x3
             -9, 0x5E, 0x79, 0x71, 0x76, 0x38, 0x5c, 0x73, 0x3e };//0-9 abcdef 显示器码数组
   6          unsigned char const INIT_CODE[] = { 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80 };//逐段点亮数码管数组
   7          unsigned char const SHANGSHUO[] = { 0x40, 0x00 }; // 点亮数码管中间段以及灭
   8          unsigned char buf_display[6][8] = { 0 }; //3个TM1629显存数组
   9          unsigned char display_ram[240] = { 0 }; //程序运行时记录显示数据的内存 
  10          unsigned char await_time_table= 0 ;//用于记录待机显示横杠数码管次数 
  11          
  12          void writeDataTo1629(unsigned char p) //写数据给第一个TM1629
  13          {
  14   1        unsigned int i;
  15   1        TM1629_STB = 0;
  16   1        for (i = 0; i<8; i++)
  17   1        {
  18   2          TM1629_CLK = 0;
  19   2          if (p & 0x01)
  20   2            TM1629_DIO = 1;
  21   2          else
  22   2            TM1629_DIO = 0;
  23   2          _nop_();
  24   2          _nop_();
  25   2          _nop_();
  26   2          _nop_();
  27   2          TM1629_CLK = 1;
  28   2          p = p >> 1;
  29   2        }
  30   1        TM1629_CLK = 0;
  31   1        TM1629_DIO = 0;
  32   1      }
  33          
  34          void writeDataTo1629_2(unsigned char p) //写数据给第二个TM1629
  35          {
  36   1        unsigned int i;
  37   1        TM1629_STB2 = 0;
  38   1        for (i = 0; i<8; i++)
  39   1        {
  40   2          TM1629_CLK = 0;
  41   2          if (p & 0x01)
  42   2            TM1629_DIO = 1;
  43   2          else
  44   2            TM1629_DIO = 0;
  45   2          _nop_();
  46   2          _nop_();
  47   2          _nop_();
  48   2          _nop_();
  49   2          TM1629_CLK = 1;
  50   2          p = p >> 1;
  51   2        }
  52   1        TM1629_CLK = 0;
  53   1        TM1629_DIO = 0;
C51 COMPILER V9.00   TM1629                                                                09/04/2015 10:18:59 PAGE 2   

  54   1      }
  55          
  56          void writeDataTo1629_3(unsigned char p) //写数据给第三个TM1629
  57          {
  58   1        unsigned int i;
  59   1        TM1629_STB3 = 0;
  60   1        for (i = 0; i<8; i++)
  61   1        {
  62   2          TM1629_CLK = 0;
  63   2          if (p & 0x01)
  64   2            TM1629_DIO = 1;
  65   2          else
  66   2            TM1629_DIO = 0;
  67   2          _nop_();
  68   2          _nop_();
  69   2          _nop_();
  70   2          _nop_();
  71   2          TM1629_CLK = 1;
  72   2          p = p >> 1;
  73   2        }
  74   1        TM1629_CLK = 0;
  75   1        TM1629_DIO = 0;
  76   1      }
  77          
  78          void send_command(unsigned char word) //写命令给第一个TM1629
  79          {
  80   1        TM1629_STB = 1;
  81   1        nop;
  82   1        TM1629_STB = 0;
  83   1        writeDataTo1629(word);
  84   1      }
  85          
  86          void send_command_2(unsigned char word) //写命令给第二个TM1629
  87          {
  88   1        TM1629_STB2 = 1;
  89   1        nop;
  90   1        TM1629_STB2 = 0;
  91   1        writeDataTo1629_2(word);
  92   1      }
  93          
  94          void send_command_3(unsigned char word) //写命令给第三个TM1629
  95          {
  96   1        TM1629_STB3 = 1;
  97   1        nop;
  98   1        TM1629_STB3 = 0;
  99   1        writeDataTo1629_3(word);
 100   1      }
 101          
 102          void display(void) //3个TM1629显示函数
 103          {
 104   1        unsigned char i;
 105   1        send_command(0x40); //设置数据命令:普通模式、地址自增1，写数据到显存
 106   1        send_command(0xc0); //设置显示地址命令：从00H开始
 107   1        for (i = 0; i<8; i++) //发送16字节的显存数据
 108   1        {
 109   2          writeDataTo1629(buf_display[0][i]);
 110   2          writeDataTo1629(buf_display[1][i]);
 111   2        }
 112   1        send_command(0x8C); //设置显示控制命令：打开显示，并设置为11/16.
 113   1        TM1629_STB = 1;
 114   1      
 115   1        send_command_2(0x40); //设置数据命令:普通模式、地址自增1，写数据到显存
C51 COMPILER V9.00   TM1629                                                                09/04/2015 10:18:59 PAGE 3   

 116   1        send_command_2(0xc0); //设置显示地址命令：从00H开始
 117   1        for (i = 0; i<8; i++) //发送16字节的显存数据
 118   1        {
 119   2          writeDataTo1629_2(buf_display[2][i]);
 120   2          writeDataTo1629_2(buf_display[3][i]);
 121   2        }
 122   1        send_command_2(0x8C); //设置显示控制命令：打开显示，并设置为11/16.
 123   1        TM1629_STB2 = 1;
 124   1      
 125   1        send_command_3(0x40); //设置数据命令:普通模式、地址自增1，写数据到显存
 126   1        send_command_3(0xc0); //设置显示地址命令：从00H开始
 127   1        for (i = 0; i<8; i++) //发送16字节的显存数据
 128   1        {
 129   2          writeDataTo1629_3(buf_display[4][i]);
 130   2          writeDataTo1629_3(buf_display[5][i]);
 131   2        }
 132   1        send_command_3(0x8C); //设置显示控制命令：打开显示，并设置为11/16.
 133   1        TM1629_STB3 = 1;
 134   1      }
 135          
 136          void tm1629_init(void) //TM1629开机初始化函数
 137          {
 138   1        unsigned char i, j, k;    //k控制显示的具体数字，i和j控制buf_display的刷新
 139   1        for (k = 0; k<8; k++)
 140   1        {
 141   2          for (i = 0; i<6; i++)
 142   2          {
 143   3            for (j = 0; j<8; j++)
 144   3            {
 145   4              buf_display[i][j] = INIT_CODE[k];
 146   4            }
 147   3          }
 148   2          display();
 149   2          Tm1629_delay(30);
 150   2        }
 151   1      }
 152          
 153          
 154          void Tm1629_delay(unsigned char k) //延时函数
 155          {
 156   1        unsigned char i, j;
 157   1        for (; k>0; k--)
 158   1        {
 159   2          for (i = 255; i>0; i--)
 160   2          {
 161   3            for (j = 255; j>0; j--)
 162   3            {
 163   4              ;
 164   4      
 165   4            }
 166   3          }
 167   2        }
 168   1      }
 169          
 170          void tm1629_clear(void)//全部归零
 171          {
 172   1        unsigned char i, j;
 173   1        for (i = 0; i<6; i++)
 174   1        {
 175   2          for (j = 0; j<8; j++)
 176   2          {
 177   3            buf_display[i][j] = 0x00;
C51 COMPILER V9.00   TM1629                                                                09/04/2015 10:18:59 PAGE 4   

 178   3          }
 179   2        }
 180   1      }
 181          
 182          void tm1629_await(void)
 183          {
 184   1        unsigned char i;  //k控制显示的具体数字，i和j控制buf_display的刷新
 185   1        unsigned char await_number_table_temp = 0;
 186   1        await_number_table_temp = return_await_number_table();
 187   1        if (await_number_table_temp == 1)
 188   1        {
 189   2          //GD5800_select_chapter(0x0008) ;
 190   2          tm1629_clear();
 191   2          i = await_time_table & 0x03;
 192   2          buf_display[0][i] = 0x40;
 193   2          display();
 194   2          set_await_number_table(0);
 195   2          await_time_table++;
 196   2          if (await_time_table == 4)
 197   2            await_time_table = 0;
 198   2        }
 199   1      }
 200          
 201          void fun0(void) //待机显示函数
 202          {
 203   1        tm1629_await();
 204   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    527    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    320       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
